# OpenCode runner image (separate from web UI)
ARG OPENCODE_BASE_IMAGE=node:20-slim
FROM ${OPENCODE_BASE_IMAGE}

ENV DEBIAN_FRONTEND=noninteractive \
    NPM_CONFIG_REGISTRY="https://registry.npmmirror.com"

# Use CN mirrors by default (override with build args if needed).
ARG APT_MIRROR="http://mirrors.tuna.tsinghua.edu.cn/debian"
ARG APT_SECURITY_MIRROR="http://mirrors.tuna.tsinghua.edu.cn/debian-security"

# Best-effort: rewrite Debian apt sources to CN mirrors.
RUN set -e; \
    for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources; do \
      [ -f "$f" ] || continue; \
      sed -i -E "s#https?://deb.debian.org/debian#${APT_MIRROR}#g" "$f"; \
      sed -i -E "s#https?://security.debian.org/debian-security#${APT_SECURITY_MIRROR}#g" "$f"; \
      sed -i -E "s#https?://security.debian.org/debian#${APT_SECURITY_MIRROR}#g" "$f"; \
    done

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        python3 \
        make \
        g++ \
        ripgrep \
    && rm -rf /var/lib/apt/lists/*

RUN npm config set registry "$NPM_CONFIG_REGISTRY" \
    && npm i -g opencode-ai gitnexus \
    && opencode --version || true \
    && gitnexus --version || true

# Create opencode config with Qwen models (simplified format without $schema)
RUN mkdir -p /root/.opencode && \
    echo '{"provider":{"openrouter":{"models":{"qwen/qwen3-max-thinking":{},"qwen/qwen3-max":{},"qwen/qwen3-coder-plus":{}}}}}' \
    > /root/.opencode/config.json

WORKDIR /repo
CMD ["opencode", "run"]
