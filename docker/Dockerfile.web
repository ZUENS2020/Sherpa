FROM python:3.10-slim

ENV PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple" \
    PIP_TRUSTED_HOST="pypi.tuna.tsinghua.edu.cn" \
    NPM_CONFIG_REGISTRY="https://registry.npmmirror.com"

WORKDIR /app

# Use CN mirrors by default (override with build args if needed).
ARG APT_MIRROR="http://mirrors.tuna.tsinghua.edu.cn/debian"
ARG APT_SECURITY_MIRROR="http://mirrors.tuna.tsinghua.edu.cn/debian-security"

# Best-effort: rewrite Debian apt sources to CN mirrors.
RUN set -e; \
    for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources; do \
      [ -f "$f" ] || continue; \
      sed -i -E "s#https?://deb.debian.org/debian#${APT_MIRROR}#g" "$f"; \
      sed -i -E "s#https?://security.debian.org/debian-security#${APT_SECURITY_MIRROR}#g" "$f"; \
      sed -i -E "s#https?://security.debian.org/debian#${APT_SECURITY_MIRROR}#g" "$f"; \
    done

# System deps:
# - git: optional fallback when GitPython path is used
# - curl/ca-certificates: install helpers (optional)
# - docker.io: docker CLI (daemon comes from dind service)
# - vim-common: provides xxd (nice-to-have)
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        docker.io \
        vim-common \
        xz-utils \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CLI (the Debian docker.io package may not include the client binary).
ARG DOCKER_CLI_TGZ_URL="https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/static/stable/x86_64/docker-27.1.1.tgz"
RUN curl -fsSL "$DOCKER_CLI_TGZ_URL" -o /tmp/docker.tgz \
    && tar -xzf /tmp/docker.tgz -C /tmp \
    && mv /tmp/docker/docker /usr/local/bin/docker \
    && chmod +x /usr/local/bin/docker \
    && rm -rf /tmp/docker /tmp/docker.tgz

COPY docker/requirements.web.txt /app/docker/requirements.web.txt
RUN python -m pip install -r /app/docker/requirements.web.txt

COPY . /app

# Optional: install OpenCode CLI. This requires network access during build.
# If you cannot reach external package registries from your build environment, rebuild with:
#   --build-arg INSTALL_OPENCODE=0
ARG INSTALL_OPENCODE=1
ARG NODE_VERSION="20.11.1"
ARG NODE_MIRROR="https://npmmirror.com/mirrors/node"
RUN if [ "$INSTALL_OPENCODE" = "1" ]; then \
            echo "Installing Node.js (for CLI tools)..."; \
            curl -fsSL "$NODE_MIRROR/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz" -o /tmp/node.tar.xz; \
            tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1; \
            rm -f /tmp/node.tar.xz; \
            npm --version; node --version; \
        fi \
    && if [ "$INSTALL_OPENCODE" = "1" ]; then \
            echo "Installing OpenCode CLI..."; \
            npm config set registry "$NPM_CONFIG_REGISTRY"; \
            npm i -g opencode-ai; \
            opencode --version || true; \
        else \
            echo "Skipping OpenCode CLI install"; \
        fi

# Run the FastAPI web UI (static + API) from its folder so relative imports work.
WORKDIR /app/harness_generator/src/langchain_agent

EXPOSE 8000

CMD ["python", "main.py"]
