FROM python:3.10-slim

ENV PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple" \
    PIP_TRUSTED_HOST="pypi.tuna.tsinghua.edu.cn" \
    NPM_CONFIG_REGISTRY="https://registry.npmmirror.com" \
    DEBIAN_FRONTEND=noninteractive

WORKDIR /app

# Use CN mirrors by default (override with build args if needed).
ARG APT_MIRROR="http://mirrors.tuna.tsinghua.edu.cn/debian"
ARG APT_SECURITY_MIRROR="http://mirrors.tuna.tsinghua.edu.cn/debian-security"

# Best-effort: rewrite Debian apt sources to CN mirrors.
RUN set -e; \
    for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources; do \
      [ -f "$f" ] || continue; \
      sed -i -E "s#https?://deb.debian.org/debian#${APT_MIRROR}#g" "$f"; \
      sed -i -E "s#https?://security.debian.org/debian-security#${APT_SECURITY_MIRROR}#g" "$f"; \
      sed -i -E "s#https?://security.debian.org/debian#${APT_SECURITY_MIRROR}#g" "$f"; \
    done

# System deps:
# - git: optional fallback when GitPython path is used
# - curl/ca-certificates: install helpers (optional)
# - docker-cli + docker-buildx: docker CLI + buildx plugin (daemon comes from dind service)
# - vim-common: provides xxd (nice-to-have)
RUN apt-get update -o Acquire::Retries=3 -o Acquire::http::Timeout=30 \
    && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        docker-cli \
        docker-buildx \
        vim-common \
        xz-utils \
    && if ! command -v docker >/dev/null 2>&1; then \
           echo "docker CLI not found after install"; \
           ls -l /usr/bin | grep -E 'docker|buildx' || true; \
           exit 1; \
       fi \
    && mkdir -p /usr/local/lib/docker/cli-plugins \
    && if [ -x /usr/libexec/docker/cli-plugins/docker-buildx ]; then \
           ln -sf /usr/libexec/docker/cli-plugins/docker-buildx /usr/local/lib/docker/cli-plugins/docker-buildx; \
       elif [ -x /usr/lib/docker/cli-plugins/docker-buildx ]; then \
           ln -sf /usr/lib/docker/cli-plugins/docker-buildx /usr/local/lib/docker/cli-plugins/docker-buildx; \
       fi \
    && docker --version \
    && rm -rf /var/lib/apt/lists/*

COPY docker/requirements.web.txt /app/docker/requirements.web.txt
RUN python -m pip install -r /app/docker/requirements.web.txt

COPY . /app

# Optional: install OpenCode CLI. This requires network access during build.
# If you cannot reach external package registries from your build environment, rebuild with:
#   --build-arg INSTALL_OPENCODE=0
ARG INSTALL_OPENCODE=1
ARG NODE_VERSION="20.11.1"
ARG NODE_MIRROR="https://npmmirror.com/mirrors/node"
ARG TARGETARCH
RUN if [ "$INSTALL_OPENCODE" = "1" ]; then \
            echo "Installing Node.js (for CLI tools)..."; \
            arch="${TARGETARCH:-$(dpkg --print-architecture)}"; \
            case "$arch" in \
                amd64|x86_64) node_arch="x64" ;; \
                arm64|aarch64) node_arch="arm64" ;; \
                *) echo "Unsupported architecture for Node.js: $arch" >&2; exit 1 ;; \
            esac; \
            curl -fsSL "$NODE_MIRROR/v$NODE_VERSION/node-v$NODE_VERSION-linux-$node_arch.tar.xz" -o /tmp/node.tar.xz; \
            tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1; \
            rm -f /tmp/node.tar.xz; \
            npm --version; node --version; \
        fi \
    && if [ "$INSTALL_OPENCODE" = "1" ]; then \
            echo "Installing OpenCode CLI..."; \
            npm config set registry "$NPM_CONFIG_REGISTRY"; \
            npm i -g opencode-ai; \
            opencode --version || true; \
        else \
            echo "Skipping OpenCode CLI install"; \
        fi

# Run the FastAPI API backend from its folder so relative imports work.
WORKDIR /app/harness_generator/src/langchain_agent

EXPOSE 8001

CMD ["python", "main.py"]
