services:
  sherpa-oss-fuzz-init:
    image: alpine/git:latest
    restart: "no"
    environment:
      SHERPA_OSS_FUZZ_REPO_URL: "https://github.com/google/oss-fuzz.git"
    volumes:
      - sherpa-oss-fuzz:/shared/oss-fuzz
    entrypoint:
      - sh
      - -lc
      - |
        set -e
        REPO="$$SHERPA_OSS_FUZZ_REPO_URL"
        if [ -z "$$REPO" ]; then
          REPO="https://github.com/google/oss-fuzz.git"
        fi
        echo "[*] Ensuring oss-fuzz checkout in /shared/oss-fuzz from $$REPO"
        if [ -f /shared/oss-fuzz/infra/helper.py ]; then
          echo "[*] oss-fuzz already present"
          exit 0
        fi
        if [ -d /shared/oss-fuzz ] && [ "$(ls -A /shared/oss-fuzz 2>/dev/null || true)" != "" ]; then
          echo "[!] /shared/oss-fuzz exists but is not a valid oss-fuzz checkout (missing infra/helper.py)" >&2
          exit 1
        fi
        rm -rf /shared/oss-fuzz/*
        git clone --depth 1 "$$REPO" /shared/oss-fuzz
        test -f /shared/oss-fuzz/infra/helper.py

  sherpa-web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      args:
        INSTALL_OPENCODE: "0"
    ports:
      - "8000:8000"
    volumes:
      # Persist job logs/config inside a docker volume (fully self-hosted).
      - sherpa-config:/app/config
      # Persist per-job logs in a dedicated volume (separate from config).
      - sherpa-job-logs:/app/job-logs
      # Mount opencode config from host
      - ./opencode.json:/app/opencode.json:ro

      # Shared temp volume (must be mounted into the Docker daemon container too).
      - sherpa-tmp:/shared/tmp

      # OSS-Fuzz checkout (must be mounted into the Docker daemon container too).
      - sherpa-oss-fuzz:/shared/oss-fuzz
      # Artifacts output directory (host-mounted).
      - ./output:/shared/output
      # Dev override: load latest local source without rebuilding the image.
      - ./harness_generator/src:/app/harness_generator/src

      # (Optional) mount a local .env containing ANTHROPIC_API_KEY.
      # - ./.env:/app/.env:ro
    environment:
      # Make Uvicorn bind for container networking (main.py reads these).
      HOST: "0.0.0.0"
      PORT: "8000"

      # Ensure all temp repos land on the shared volume so Docker mounts work.
      TMPDIR: "/shared/tmp"

      # Route docker CLI calls to the dind daemon.
      DOCKER_HOST: "tcp://sherpa-docker:2375"
      DOCKER_BUILDKIT: "0"

      # Default OSS-Fuzz checkout path inside containers.
      # Must be the SAME path in both sherpa-web and sherpa-docker so dind mounts work.
      SHERPA_DEFAULT_OSS_FUZZ_DIR: "/shared/oss-fuzz"
      # Default output directory for artifacts (host-mounted).
      SHERPA_OUTPUT_DIR: "/shared/output"
      # CLI backend for code edits (opencode).
      SHERPA_CODEX_CLI: "${SHERPA_CODEX_CLI:-opencode}"
      SHERPA_OPENCODE_DOCKER_IMAGE: "sherpa-opencode:latest"
      SHERPA_OPENCODE_IGNORE_RETRY_ERRORS: "1"

      # Optional override for oss-fuzz upstream (mirrors / forks).
      SHERPA_OSS_FUZZ_REPO_URL: "https://github.com/google/oss-fuzz.git"

      # Optional Git mirrors for clone operations.
      SHERPA_GIT_MIRRORS: ""

      # OpenRouter API (for all AI features)
      OPENROUTER_API_KEY: ""
      OPENROUTER_MODEL: ""
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}

      # OpenCode model override for OpenAI-compatible endpoints
      OPENCODE_MODEL: "deepseek/deepseek-reasoner"
      OPENAI_MODEL: "deepseek-reasoner"
      OPENCODE_CONFIG: "/opencode.json"
      SHERPA_WEB_JOB_LOG_DIR: "/app/job-logs/jobs"

      # Optional (fuzz patching): where to read ANTHROPIC_API_KEY from.
      # AI_KEY_PATH: "/app/.env"
      # SHERPA_ACCEPT_DIFF_WITHOUT_DONE: "1"
    depends_on:
      sherpa-oss-fuzz-init:
        condition: service_completed_successfully
      sherpa-docker:
        condition: service_healthy

  sherpa-docker:
    image: docker:27-dind
    privileged: true
    restart: unless-stopped
    command:
      - --host=tcp://0.0.0.0:2375
      - --host=unix:///var/run/docker.sock
      - --tls=false
    healthcheck:
      test: ["CMD-SHELL", "docker info >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    environment:
      DOCKER_TLS_CERTDIR: ""
      DOCKER_HOST: tcp://0.0.0.0:2375
    volumes:
      - sherpa-docker-data:/var/lib/docker
      - sherpa-tmp:/shared/tmp
      - sherpa-oss-fuzz:/shared/oss-fuzz
      - ./output:/shared/output
      - ./opencode.json:/opencode.json:ro

  sherpa-opencode:
    build:
      context: .
      dockerfile: docker/Dockerfile.opencode
    image: sherpa-opencode:latest
    restart: "no"
    profiles:
      - opencode

volumes:
  sherpa-docker-data:
  sherpa-tmp:
  sherpa-config:
  sherpa-job-logs:
  sherpa-oss-fuzz:
