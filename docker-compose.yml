services:
  # Bootstrap container: ensure shared oss-fuzz checkout exists before web starts.
  sherpa-oss-fuzz-init:
    image: alpine/git:latest
    restart: "no"
    environment:
      SHERPA_OSS_FUZZ_REPO_URL: "https://github.com/google/oss-fuzz.git"
    volumes:
      - sherpa-oss-fuzz:/shared/oss-fuzz
    entrypoint:
      - sh
      - -lc
      - |
        set -e
        REPO="$$SHERPA_OSS_FUZZ_REPO_URL"
        if [ -z "$$REPO" ]; then
          REPO="https://github.com/google/oss-fuzz.git"
        fi
        echo "[*] Ensuring oss-fuzz checkout in /shared/oss-fuzz from $$REPO"
        if [ -f /shared/oss-fuzz/infra/helper.py ]; then
          echo "[*] oss-fuzz already present"
          exit 0
        fi
        if [ -d /shared/oss-fuzz ] && [ "$(ls -A /shared/oss-fuzz 2>/dev/null || true)" != "" ]; then
          echo "[warn] /shared/oss-fuzz exists but is not a valid oss-fuzz checkout (missing infra/helper.py)" >&2
          echo "[warn] Cleaning stale contents and re-cloning..." >&2
        fi
        rm -rf /shared/oss-fuzz/* /shared/oss-fuzz/.[!.]* /shared/oss-fuzz/..?* || true
        git clone --depth 1 "$$REPO" /shared/oss-fuzz
        test -f /shared/oss-fuzz/infra/helper.py

  # API backend only: workflow orchestration + task/log/config endpoints.
  sherpa-web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      args:
        INSTALL_OPENCODE: "0"
    expose:
      - "8001"
    volumes:
      # Persist job logs/config inside a docker volume (fully self-hosted).
      - sherpa-config:/app/config
      # Persist per-job logs in a dedicated volume (separate from config).
      - sherpa-job-logs:/app/job-logs
      # Persist SQLite job state in a dedicated volume managed by sherpa-job-store.
      - sherpa-job-store-data:/app/job-store

      # Shared temp volume (must be mounted into the Docker daemon container too).
      - sherpa-tmp:/shared/tmp

      # OSS-Fuzz checkout (must be mounted into the Docker daemon container too).
      - sherpa-oss-fuzz:/shared/oss-fuzz
      # Artifacts output directory (host-mounted).
      - ./output:/shared/output
      # Dev override: load latest local source without rebuilding the image.
      - ./harness_generator/src:/app/harness_generator/src

      # (Optional) mount a local .env containing API keys (OPENAI_API_KEY / OPENROUTER_API_KEY).
      # - ./.env:/app/.env:ro
    environment:
      # Make Uvicorn bind for container networking (main.py reads these).
      HOST: "0.0.0.0"
      PORT: "8001"

      # Ensure all temp repos land on the shared volume so Docker mounts work.
      TMPDIR: "/shared/tmp"

      # Route docker CLI calls to the dind daemon.
      DOCKER_HOST: "tcp://sherpa-docker:2375"
      DOCKER_BUILDKIT: "1"

      # Default OSS-Fuzz checkout path inside containers.
      # Must be the SAME path in both sherpa-web and sherpa-docker so dind mounts work.
      SHERPA_DEFAULT_OSS_FUZZ_DIR: "/shared/oss-fuzz"
      # Default output directory for artifacts (host-mounted).
      SHERPA_OUTPUT_DIR: "/shared/output"
      # CLI backend for code edits (opencode).
      SHERPA_CODEX_CLI: "${SHERPA_CODEX_CLI:-opencode}"
      SHERPA_OPENCODE_DOCKER_IMAGE: "sherpa-opencode:latest"
      SHERPA_OPENCODE_IGNORE_RETRY_ERRORS: "1"
      # GitNexus auto-analysis for OpenCode context enhancement.
      SHERPA_GITNEXUS_AUTO_ANALYZE: ${SHERPA_GITNEXUS_AUTO_ANALYZE:-1}
      SHERPA_GITNEXUS_SKIP_EMBEDDINGS: ${SHERPA_GITNEXUS_SKIP_EMBEDDINGS:-1}
      SHERPA_PARALLEL_FUZZERS: ${SHERPA_PARALLEL_FUZZERS:-2}
      SHERPA_RUN_UNLIMITED_ROUND_BUDGET_SEC: ${SHERPA_RUN_UNLIMITED_ROUND_BUDGET_SEC:-7200}

      # Optional override for oss-fuzz upstream (mirrors / forks).
      SHERPA_OSS_FUZZ_REPO_URL: "https://github.com/google/oss-fuzz.git"

      # Optional Git mirrors for clone operations.
      SHERPA_GIT_MIRRORS: ""

      # OpenRouter API (for all AI features)
      OPENROUTER_API_KEY: ""
      OPENROUTER_MODEL: ""
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}

      # OpenCode model override for OpenAI-compatible endpoints
      OPENCODE_MODEL: "deepseek/deepseek-reasoner"
      OPENAI_MODEL: "deepseek-reasoner"
      OPENCODE_CONFIG: "/app/config/opencode.generated.json"
      SHERPA_WEB_JOB_LOG_DIR: "/app/job-logs/jobs"
      SHERPA_WEB_JOB_DB_PATH: "/app/job-store/jobs.sqlite3"

      # Optional (fuzz patching): where to read API key env file from.
      # AI_KEY_PATH: "/app/.env"
    depends_on:
      sherpa-oss-fuzz-init:
        condition: service_completed_successfully
      sherpa-job-store:
        condition: service_started
      sherpa-docker:
        condition: service_healthy

  # Dedicated SQLite sidecar for job-state data volume ownership/inspection.
  sherpa-job-store:
    image: keinos/sqlite3:latest
    restart: unless-stopped
    user: "0:0"
    command:
      - sh
      - -lc
      - |
        set -eu
        mkdir -p /data
        chmod 0770 /data || true
        touch /data/jobs.sqlite3
        chmod 0660 /data/jobs.sqlite3 || true
        exec tail -f /dev/null
    volumes:
      - sherpa-job-store-data:/data

  # Docker daemon sidecar (dind): build/run fuzz runtime containers.
  sherpa-docker:
    image: docker:27-dind
    privileged: true
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - ${SHERPA_DOCKER_DNS_1:-1.1.1.1}
      - ${SHERPA_DOCKER_DNS_2:-8.8.8.8}
    entrypoint:
      - sh
      - -lc
      - |
        set -eu
        ARGS="--host=tcp://0.0.0.0:2375 --host=unix:///var/run/docker.sock --tls=false"
        if [ -n "$${SHERPA_DOCKER_REGISTRY_MIRROR:-}" ]; then
          ARGS="$$ARGS --registry-mirror=$${SHERPA_DOCKER_REGISTRY_MIRROR}"
          echo "[*] Using docker registry mirror: $${SHERPA_DOCKER_REGISTRY_MIRROR}"
        fi
        exec dockerd-entrypoint.sh $$ARGS
    healthcheck:
      test: ["CMD-SHELL", "docker info >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    environment:
      DOCKER_TLS_CERTDIR: ""
      DOCKER_HOST: unix:///var/run/docker.sock
      # Route docker daemon egress through host proxy (default: host.docker.internal:7897).
      HTTP_PROXY: ${SHERPA_DOCKER_HTTP_PROXY:-http://host.docker.internal:7897}
      HTTPS_PROXY: ${SHERPA_DOCKER_HTTPS_PROXY:-http://host.docker.internal:7897}
      NO_PROXY: ${SHERPA_DOCKER_NO_PROXY:-localhost,127.0.0.1,::1,host.docker.internal,sherpa-docker}
      http_proxy: ${SHERPA_DOCKER_HTTP_PROXY:-http://host.docker.internal:7897}
      https_proxy: ${SHERPA_DOCKER_HTTPS_PROXY:-http://host.docker.internal:7897}
      no_proxy: ${SHERPA_DOCKER_NO_PROXY:-localhost,127.0.0.1,::1,host.docker.internal,sherpa-docker}
      # Default mirror uses xuanyuan; can still be overridden by local env.
      SHERPA_DOCKER_REGISTRY_MIRROR: ${SHERPA_DOCKER_REGISTRY_MIRROR:-https://7m856d3fdvb9yp.xuanyuan.run}
    volumes:
      - sherpa-docker-data:/var/lib/docker
      - sherpa-config:/app/config
      - sherpa-tmp:/shared/tmp
      - sherpa-oss-fuzz:/shared/oss-fuzz
      - ./output:/shared/output

  # Optional helper image for OpenCode CLI.
  sherpa-opencode:
    build:
      context: .
      dockerfile: docker/Dockerfile.opencode
    image: sherpa-opencode:latest
    restart: "no"
    profiles:
      - opencode

  # Frontend UI service (Next.js).
  sherpa-frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_BASE: "/api"
      NEXT_PUBLIC_SENTRY_DSN: "${NEXT_PUBLIC_SENTRY_DSN:-}"
    depends_on:
      sherpa-web:
        condition: service_started

  # Single public entrypoint: "/" -> frontend, "/api/*" -> web backend.
  sherpa-gateway:
    image: nginx:1.27-alpine
    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      - ./docker/nginx/sherpa.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      sherpa-web:
        condition: service_started
      sherpa-frontend:
        condition: service_started

volumes:
  sherpa-docker-data:
  sherpa-tmp:
  sherpa-config:
  sherpa-job-logs:
  sherpa-job-store-data:
  sherpa-oss-fuzz:
